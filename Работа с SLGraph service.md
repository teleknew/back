## Введение

При разработке SL Graph service для межпроцессного взаимодействия был выбран протокол gRPC. Это протокол удаленного вызова процедур (Remote procedure call), разработанный компаний Google в 2015. Основными преимуществами gRPC перед REST: 
* так как протокол бинарный, а не текстовый, то сокращается объём передаваемого трафика;
* строгая типизация передаваемых сообщений;
* протокол можно использовать как для общения между процессами внутри одной ОС, так и в качестве внешнего API;

На данный момент gRPC активно используют крупнейшие компании такие как Google, Microsoft, Yandex и др.
Для разработки в gRPC используется подход, при котором сначала создается контракт. Службы и сообщения определяются в proto-файлах. Дальше эти proto-файлы генерируются в клиентский и серверный код одного из поддерживаемых языков программирования.

## Термины
**gRPC** – протокол взаимодействия
**Protocol buffer** – протокол сериализации, используемый в gRPC
**proto-файлы** – файлы содержащие описание процедур и типов сообщений\объектов для Protocol buffer
Часто опускают связку Protocol buffer и proto-файлов и используют термин «протобаф\протобуф\», мы в СофтЛабе делаем так же.
## Принципиальное взаимодействие клиента с SL Graph service

SL Graph service выступает в качестве внешнего сервера, к которому по gRPC направляются строго определённые запросы типа Unary, т.е. клиент отправляет один запрос на сервер и получает один ответ обратно, как при обычном вызове функции. При этом из-за особенностей протобафа, вызываемая процедура всегда имеет ровно один параметр и всегда что-то возвращает. Поэтому, когда нужно вызвать процедуру без параметра или у процедуры нет результата вызова, применяется пустое сообщение SLEmptyProto.

Структура прото-файлов SL Graph service:
1) **sl_graph_service.proto** – основной файл, в котором описаны все процедуры и многие типы сообщений. Из него формируется объект для клиентских вызовов
2) **sl_mpeg_ts.proto** – здесь описаны TS-таблицы и их дескрипторы, получаемые во входных устройствах
3) **sl_remuxer_model.proto** – здесь описана модель выхода (SLModelProto) и её сопутствующие объекты
Остальные прото-файлы используются для генерации серверного кода.

## Описание вызываемых процедур


***create_graph*** – создаёт новый граф
**Входной параметр:** новый объект SLGraphProto с указанным именем (свойство name) и типо графа (type)
**Возвращает:** Новосозданный граф с теми же параметрами + guid

***get_graph_list*** – список существующих графов
**Входные параметры:** SLEmptyProto
**Возвращает:** Объект SLGraphList с единственным свойством list – массив SLGraphProto

***delete_graph*** – удаляет граф
**Входные параметры:** объект SLGraphProto, который нужно удалить
**Возвращает:** SLEmptyProto

***get_input_device_list*** – все доступные входные устройства
**Входные параметры:** SLEmptyProto
**Возвращает:**  объект SLDeviceListProto с единственным свойством list – массив SLDeviceProto

***get_output_device_list*** - все доступные выходные устройства
**Входные параметры:** SLEmptyProto
**Возвращает:**  объект SLDeviceListProto с единственным свойством list – массив SLDeviceProto

***get_graph_input_device_list*** – входные устройства, которые установлены графу
**Входные параметры:** SLGraphProto – граф входные устройства которого нужно вернуть
**Возвращает:**  объект SLDeviceListProto с единственным свойством list – массив SLDeviceProto

***get_graph_output_device_list*** - выходные устройства, которые установлены графу
**Входные параметры:** SLGraphProto – граф выходные устройства которого нужно вернуть
**Возвращает:**  объект SLDeviceListProto с единственным свойством list – массив SLDeviceProto

***add_input_device_to_graph*** – добавляет входные устройство в граф
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – устройство, которое нужно добавить, а graph – это граф для которого нужно добавить device
**Возвращает:**  объект SLDeviceProto – добавленное устройство

***delete_input_device_from_graph*** – удаляет входное устройство из графа
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – устройство, которое нужно удалить, а graph – это граф из которого нужно удалить device
**Возвращает:**  SLEmptyProto

***add_output_device_to_graph*** – добавляет выходное устройство в граф
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – устройство, которое нужно добавить, а graph – это граф для которого нужно добавить device
**Возвращает:**  объект SLDeviceProto – добавленное устройство

***delete_output_device_from_graph*** – удаляет выходное устройство из графа
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – устройство, которое нужно удалить, а graph – это граф из которого нужно удалить device
**Возвращает:**  SLEmptyProto

***set_output_device_settings*** – устанавливает новые настройки для выходного устройства
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – устройство с изменёнными настройками, а graph – это граф для которого нужно исправить настройки device
**Возвращает:**  объект SLDeviceProto – выходное устройство с новыми настройками

***start_graph*** – запускает граф
Входной параметр: SLGraphProto который нужно запустить
**Возвращает:** SLEmptyProto

***stop_graph*** – останавливает граф
Входной параметр: SLGraphProto который нужно остановить
**Возвращает:** SLEmptyProto

***get_device_statistics*** – служит для запроса статистики устройства
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – устройство, чью статистику нужно вернуть
**Возвращает:**  объект SLStatisticsProto, который содержит статистику устройств в момент запроса

***get_remuxer_statistics*** – служит для запроса статистики ремультиплексирования
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – устройство, чью статистику нужно вернуть
**Возвращает:**  объект SLStatisticsProto, который содержит статистику устройств в момент запроса

***get_affinity_mask*** – служит для запроса установленных настроек Affinity mask (сколько логических процессоров может использовать граф)
**Входные параметры:** SLGraphProto – для какого графа нужны настройки
**Возвращает:**  объект SLAffinityMaskProto, описывающий установленные настройки

***set_affinity_mask*** – устанавливает новые настройки для Affinity mask
**Входные параметры:** SLGraphAffinityMaskProto – объект двумя свойствами: graph – для какого графа новые настройки, affinity – объект SLAffinityMaskProto с новыми настройками
**Возвращает:**  объект SLAffinityMaskProto с новыми настройками

***get_graph_log*** – лог событий сделанных клиентом графа
**Входные параметры:** SLGraphProto – чей лог интересует
**Возвращает:**  объект SLLogProto – по сути массив строк-событий

***clear_log*** – очищает лог событий графа
**Входные параметры:** SLGraphProto – чей лог нужно очистить
**Возвращает:**  SLEmptyProto

***get_remuxer_input_info*** – возвращает распарсенную информацию транспортных потоков с входных устройст. Работает даже на остановленном графе
**Входные параметры:** SLGraphDeviceProto – объект с полями graph и device, где device – входное устройство графа
**Возвращает:** объект SLInputInfoProto, содержащий таблицы транспортного потока на входе

***get_remuxer_model*** – возвращает установленную модель выхода для графа
**Входные параметры:** SLGraphProto – граф чью модель нужно вернуть
**Возвращает:** SLModelProto – текущая модель выходного ремультиплексирования графа

***set_remuxer_model*** – служит для внесения изменений в выходную модель графа
**Входные параметры:** SLGraphRemuxerModelProto – объект с двумя свойствами: graph – граф для которого нужно установить модель, model – непосредственно модель с новыми изменениями
**Возвращает:** SLModelProto – исправленная модель

## Примечания по использованию протобафа

1)  Так как процедуры протобафа принимают ровно один аргумент, то используются объекты-обёртки для случаев, когда нужно передать несколько аргументов. Например, SLGraphDeviceProto – это объект свойствами которого являются два объекта граф и устройство.
2)  SLModelProto или прост модель – это логический выход графа, в котором описаны настройки ремультиплексирования входных таблиц. В графе может быть только одна модель, но эта модель может быть выведена на несколько выходных устройств.
3)  Так как настройки устройств имеют самые различные структуры, было решено хранить настройки устройств в виде строки, которая преобразуется в JSON.
4)  Если у таблицы модели одно единственное свойство – input, значит в это свойство прописывается GUID входного устройства с которого пронесётся эта таблица.
